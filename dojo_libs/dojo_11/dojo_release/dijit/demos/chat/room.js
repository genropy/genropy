/*
	Copyright (c) 2004-2008, The Dojo Foundation
	All Rights Reserved.

	Licensed under the Academic Free License version 2.1 or above OR the
	modified BSD license. For more information on Dojo licensing, see:

		http://dojotoolkit.org/book/dojo-book-0-9/introduction/licensing
*/


if(!dojo._hasResource["dijit.demos.chat.room"]){dojo._hasResource["dijit.demos.chat.room"]=true;dojo.provide("dijit.demos.chat.room");dojo.require("dojox.cometd");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.declare("dijit.demos.chat.Room",[dijit._Widget,dijit._Templated],{_last:"",_username:null,roomId:"public",isPrivate:false,prompt:"Name:",templateString:"<div id=\"${id}\" class=\"chatroom\">"+"<div dojoAttachPoint=\"chatNode\" class=\"chat\"></div>"+"<div dojoAttachPoint=\"input\" class=\"input\">"+"<div dojoAttachPoint=\"joining\">"+"<span>${prompt}</span><input class=\"username\" dojoAttachPoint=\"username\" type=\"text\" dojoAttachEvent=\"onkeyup: _join\"> <input dojoAttachPoint=\"joinB\" class=\"button\" type=\"submit\" name=\"join\" value=\"Contact\" dojoAttachEvent=\"onclick: _join\"/>"+"</div>"+"<div dojoAttachPoint=\"joined\" class=\"hidden\">"+"<input type=\"text\" class=\"phrase\" dojoAttachPoint=\"phrase\" dojoAttachEvent=\"onkeyup: _cleanInput\" />"+"<input type=\"submit\" class=\"button\" value=\"Send\" dojoAttachPoint=\"sendB\" dojoAttachEvent=\"onclick: _sendPhrase\"/>"+"</div>"+"</div>"+"</div>",join:function(_1){if(_1==null||_1.length==0){alert("Please enter a username!");}else{if(this.isPrivate){this.roomId=_1;}this._username=_1;this.joining.className="hidden";this.joined.className="";this.phrase.focus();console.log(this.roomId);dojox.cometd.subscribe("/chat/demo/"+this.roomId,this,"_chat");dojox.cometd.publish("/chat/demo/"+this.roomId,{user:this._username,join:true,chat:this._username+" has joined the room."});dojox.cometd.publish("/chat/demo",{user:this._username,joined:this.roomId});}},_join:function(e){var _3=(e.charCode==dojo.keys.SPACE?dojo.keys.SPACE:e.keyCode);if(_3==dojo.keys.ENTER||e.type=="click"){this.join(this.username.value);}},leave:function(){dojox.cometd.unsubscribe("/chat/demo/"+this.roomId,this,"_chat");dojox.cometd.publish("/chat/demo/"+this.roomId,{user:this._username,leave:true,chat:this._username+" has left the chat."});this.joining.className="";this.joined.className="hidden";this.username.focus();this._username=null;},chat:function(_4){if(_4!=null&&_4.length>0){_4=_4.replace(/</g,"&lt;");_4=_4.replace(/>/g,"&gt;");dojox.cometd.publish("/chat/demo/"+this.roomId,{user:this._username,chat:_4});}},_chat:function(_5){if(!_5.data){console.warn("bad message format "+_5);return;}var _6=_5.data.user;var _7=_5.data.join||_5.data.leave;var _8=_5.data.chat;if(_8!=null){if(!_7&&_6==this._last){_6="...";}else{this._last=_6;_6+=":";}if(_7){this.chatNode.innerHTML+="<span class=\"alert\"><span class=\"from\">"+_6+"&nbsp;</span><span class=\"text\">"+_8+"</span></span><br/>";this._last="";}else{this.chatNode.innerHTML+="<span class=\"from\">"+_6+"&nbsp;</span><span class=\"text\">"+_8+"</span><br/>";this.chatNode.scrollTop=this.chatNode.scrollHeight-this.chatNode.clientHeight;}}},startup:function(){this.joining.className="";this.joined.className="hidden";this.username.setAttribute("autocomplete","OFF");if(this.registeredAs){this.join(this.registeredAs);}this.inherited("startup",arguments);},_cleanInput:function(e){var _a=(e.charCode==dojo.keys.SPACE?dojo.keys.SPACE:e.keyCode);if(_a==dojo.keys.ENTER||_a==13){this.chat(this.phrase.value);this.phrase.value="";}},_sendPhrase:function(e){if(this.phrase.value){this.chat(this.phrase.value);this.phrase.value="";}}});}